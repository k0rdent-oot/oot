apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: KubevirtMachineTemplate
metadata:
  name: {{ include "kubevirtmachinetemplate.controlplane.name" . }}
  namespace: {{ .Values.cluster.namespace | default .Release.Namespace | trunc 63 }}
spec:
  template:
    spec:
      virtualMachineBootstrapCheck:
        checkStrategy: {{ .Values.controlPlane.bootstrapCheckStrategy }}
      virtualMachineTemplate:
        metadata:
          namespace: {{ .Values.cluster.namespace | default .Release.Namespace | trunc 63 }}
          {{- with .Values.controlPlane.annotations }}
          annotations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
        spec:
          runStrategy: {{ .Values.controlPlane.runStrategy }}
          template:
            metadata:
              {{- with .Values.controlPlane.annotations }}
              annotations:
                {{- toYaml . | nindent 16 }}
              {{- end }}
            spec:
              {{- with .Values.controlPlane.nodeSelector }}
              nodeSelector:
                {{- toYaml . | nindent 16 }}
              {{- end }}
              # https://doc.crds.dev/github.com/kubernetes-sigs/cluster-api-provider-kubevirt/infrastructure.cluster.x-k8s.io/KubevirtMachineTemplate/v1alpha1@v0.1.9#spec-template-spec-virtualMachineTemplate-spec-template
              domain:
                cpu:
                  cores: {{ .Values.controlPlane.cpus }}
                  {{- if .Values.controlPlane.cpu.dedicatedCpuPlacement }}
                  dedicatedCpuPlacement: {{ .Values.controlPlane.cpu.dedicatedCpuPlacement }}
                  {{- end }}
                  {{- if .Values.controlPlane.cpu.isolateEmulatorThread }}
                  isolateEmulatorThread: {{ .Values.controlPlane.cpu.isolateEmulatorThread }}
                  {{- end }}
                  {{- if .Values.controlPlane.cpu.model }}
                  model: {{ .Values.controlPlane.cpu.model }}
                  {{- end }}
                  {{- with .Values.controlPlane.cpu.numa }}
                  numa:
                    {{- toYaml . | nindent 20 }}
                  {{- end }}
                {{- if .Values.controlPlane.ioThreadsPolicy }}
                ioThreadsPolicy: {{ .Values.controlPlane.ioThreadsPolicy }}
                {{- end }}
                devices:
                  {{- if .Values.controlPlane.blockMultiQueue }}
                  blockMultiQueue: {{ .Values.controlPlane.blockMultiQueue }}
                  {{- end }}
                  {{- if hasKey .Values.controlPlane.devices "autoattachMemBalloon" }}
                  autoattachMemBalloon: {{ .Values.controlPlane.devices.autoattachMemBalloon }}
                  {{- end }}
                  {{- if hasKey .Values.controlPlane.devices "autoattachSerialConsole" }}
                  autoattachSerialConsole: {{ .Values.controlPlane.devices.autoattachSerialConsole }}
                  {{- end }}
                  {{- if hasKey .Values.controlPlane.devices "autoattachGraphicsDevice" }}
                  autoattachGraphicsDevice: {{ .Values.controlPlane.devices.autoattachGraphicsDevice }}
                  {{- end }}
                  interfaces:
                  - name: default
                    {{- if eq .Values.controlPlane.defaultNetworkInterface.type "bridge" }}
                    bridge: {}
                    {{- else if eq .Values.controlPlane.defaultNetworkInterface.type "masquerade" }}
                    masquerade: {}
                    {{- if .Values.controlPlane.defaultNetworkInterface.ports }}
                    ports:
                      {{- toYaml .Values.controlPlane.defaultNetworkInterface.ports | nindent 22 }}
                    {{- end }}
                    {{- else if eq .Values.controlPlane.defaultNetworkInterface.type "sriov" }}
                    sriov: {}
                    {{- else }}
                    bridge: {}
                    {{- end }}
                  {{- range .Values.controlPlane.additionalNetworkInterfaces }}
                  - name: {{ .name }}
                    bridge: {}
                  {{- end }}
                  disks:
                  {{- if .Values.controlPlane.dataVolumes }}
                  {{- range .Values.controlPlane.dataVolumes }}
                    - disk:
                        bus: virtio
                      name: {{ .name }}
                  {{- end }}
                  {{- else }}
                    - disk:
                        bus: virtio
                      name: containerdisk
                      {{- if .Values.controlPlane.diskCache }}
                      cache: {{ .Values.controlPlane.diskCache }}
                      {{- end }}
                  {{- if .Values.controlPlane.cloudInit.userData }}
                    - disk:
                        bus: virtio
                      name: cloudinitdisk
                  {{- end }}
                  {{- end }}
                  {{- range .Values.controlPlane.hostDisks }}
                    - disk:
                        bus: virtio
                      name: {{ .name }}
                  {{- end }}
                  {{- with .Values.controlPlane.devices.hostDevices }}
                  hostDevices:
                    {{- toYaml . | nindent 20 }}
                  {{- end }}
                  networkInterfaceMultiqueue: {{ .Values.controlPlane.networkInterfaceMultiqueue }}
                {{- if or .Values.controlPlane.memoryConfig.hugepages .Values.controlPlane.memoryConfig.guest }}
                memory:
                  {{- if .Values.controlPlane.memoryConfig.guest }}
                  guest: {{ .Values.controlPlane.memoryConfig.guest }}
                  {{- else }}
                  guest: {{ .Values.controlPlane.memory }}
                  {{- end }}
                  {{- with .Values.controlPlane.memoryConfig.hugepages }}
                  hugepages:
                    {{- toYaml . | nindent 20 }}
                  {{- end }}
                {{- else }}
                memory:
                  guest: {{ .Values.controlPlane.memory }}
                {{- end }}
                {{- if or .Values.controlPlane.memoryConfig.requests .Values.controlPlane.memoryConfig.limits }}
                resources:
                  {{- if .Values.controlPlane.memoryConfig.requests }}
                  requests:
                    memory: {{ .Values.controlPlane.memoryConfig.requests }}
                  {{- end }}
                  {{- if .Values.controlPlane.memoryConfig.limits }}
                  limits:
                    memory: {{ .Values.controlPlane.memoryConfig.limits }}
                  {{- end }}
                {{- end }}
              evictionStrategy: External
              networks:
                - name: default
                  pod: {}
              {{- with .Values.controlPlane.additionalNetworkInterfaces }}
                {{- toYaml . | nindent 16 }}
              {{- end }}
              volumes:
                {{- if .Values.controlPlane.dataVolumes }}
                {{- range .Values.controlPlane.dataVolumes }}
                - name: {{ .name }}
                  dataVolume:
                    name: {{ .name }}
                {{- end }}
                {{- else }}
                - name: containerdisk
                  containerDisk:
                    image: {{ .Values.controlPlane.image }}
                    {{- if .Values.controlPlane.imagePullPolicy }}
                    imagePullPolicy: {{ .Values.controlPlane.imagePullPolicy }}
                    {{- end }}
                {{- if .Values.controlPlane.cloudInit.userData }}
                - name: cloudinitdisk
                  cloudInitNoCloud:
                    userData: {{ .Values.controlPlane.cloudInit.userData | quote }}
                {{- end }}
                {{- end }}
                {{- range .Values.controlPlane.hostDisks }}
                - name: {{ .name }}
                  hostDisk:
                    path: {{ .path }}
                    type: {{ .type | default "Disk" }}
                {{- end }}
          {{- if .Values.controlPlane.dataVolumes }}
          dataVolumeTemplates:
          {{- range .Values.controlPlane.dataVolumes }}
          - apiVersion: cdi.kubevirt.io/v1beta1
            kind: DataVolume
            metadata:
              name: {{ .name }}
              annotations:
                # https://github.com/kubevirt/containerized-data-importer/blob/main/doc/waitforfirstconsumer-storage-handling.md
                cdi.kubevirt.io/storage.bind.immediate.requested: ""
            spec:
              pvc:
                accessModes:
                - {{ .accessModes }}
                resources:
                  requests:
                    storage: {{ .storage }}
                volumeMode: {{ .volumeMode }}
                storageClassName: {{ .storageClassName }}
              source:
                {{- toYaml .source | nindent 16 }}
          {{- end }}
          {{- end }}
